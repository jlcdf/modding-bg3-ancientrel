Version 1
SubGoalCombiner SGC_AND
INITSECTION
// ==================================
// PREVENT ARCANIZER CHEST FROM BEING DROPPED OR TRANSFERRED
// ==================================
DB_AMP_Arcanizer_DropBlocked(0);
KBSECTION
// MAIN DROP PREVENTION - SIMPLER AND MORE RELIABLE
// The core issue was likely with the DB_AMP_Arcanizer_Owner check
// Not every character dropping the Arcanizer would be in this DB
IF
DroppedBy((ITEM)_Item, (CHARACTER)_Character) 
AND
IsTagged(_Item, (TAG)ARCANIZER_MAIN_c4302d38-d7a9-4522-8912-e8c3f53766f5, 1)
THEN
// Show message
OpenMessageBox(_Character, "The Arcanizer refuses to leave your possession.");
// Return to inventory - unconditional
Pickup(_Character, _Item, "", 1);

// TRANSFER PREVENTION - SEPARATE FROM DROP HANDLING
// This handles player-to-player transfers with proper ownership checking
IF
AddedTo((ITEM)_Item, (CHARACTER)_NewOwner, _)
AND
IsTagged(_Item, (TAG)ARCANIZER_MAIN_c4302d38-d7a9-4522-8912-e8c3f53766f5, 1)
AND
DB_AMP_Arcanizer_Owner((CHARACTER)_RightfulOwner)
AND
_NewOwner != _RightfulOwner
AND
_RightfulOwner != NULL_00000000-0000-0000-0000-000000000000
AND
DB_AMP_Arcanizer_DropBlocked(0)
THEN
// Set flag to prevent recursive handling
NOT DB_AMP_Arcanizer_DropBlocked(0);
DB_AMP_Arcanizer_DropBlocked(1);
// Show message to new owner
OpenMessageBox(_NewOwner, "The Arcanizer cannot be transferred to anyone else.");
// Return to rightful owner
ToInventory(_Item, _RightfulOwner, 1, 1, 0);
// Reset flag after a delay to prevent recursion
TimerLaunch("AMP_ResetDropBlockFlag", 300);

// Reset flag handler - kept separate and simple
IF
TimerFinished("AMP_ResetDropBlockFlag")
THEN
NOT DB_AMP_Arcanizer_DropBlocked(1);
DB_AMP_Arcanizer_DropBlocked(0);
EXITSECTION

ENDEXITSECTION
